name: CI Tests for Pull Requests

on:
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: üß™ Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]  # [ubuntu-latest, windows-latest, macos-latest]
        python-version: [3.13]  # ["3.10", "3.11", "3.12", "3.13"]
    outputs:
      matrix-result: ${{ steps.set-result.outputs.result }}

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          check-latest: true

      - name: üîß Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade poetry

      - name: üìö Install Dependencies
        run: poetry install --with test

      - name: üß™ Run Tests
        id: tests
        run: make tests
        continue-on-error: true

      - name: üìä Set Result
        id: set-result
        if: always()
        run: |
          echo "result={\"os\":\"${{ matrix.os }}\",\"python\":\"${{ matrix.python-version }}\",\"status\":\"${{ steps.tests.outcome }}\"}" >> $GITHUB_OUTPUT

  report:
    name: üìù Report Test Results
    needs: test
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: üìä Generate Report
        uses: actions/github-script@v7
        with:
          script: |
            const results = ${{ needs.test.outputs.matrix-result }};
            const parsedResults = Array.isArray(results) ? results : [results];

            const emoji = (status) => status === 'success' ? '‚úÖ' : '‚ùå';
            const formatOS = (os) => os.replace('-latest', '');

            let tableRows = [];
            for (const result of parsedResults) {
              const data = JSON.parse(result);
              tableRows.push(`| ${formatOS(data.os)} | ${data.python} | ${emoji(data.status)} ${data.status} |`);
            }

            const message = `
            ### Thank you for your commit! üôè

            Here are the test results:

            | OS | Python Version | Status |
            |----|----------------|--------|
            ${tableRows.join('\n')}

            [View Details](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
