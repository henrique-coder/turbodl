name: CI Tests for Pull Requests

on:
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    steps:
      - name: ğŸ”’ Security Scan Dependencies
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip
          check-latest: true

      - name: ğŸ”§ Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade poetry

      - name: ğŸ“š Install Dependencies
        run: poetry install --with test

      - name: ğŸ§ª Run Tests via Makefile
        run: make tests

      - name: ğŸ“ Report Test Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = context.steps.tests.outcome === 'success';
            const message = `## ğŸ§ª Test Results\n\n${success ? 'âœ… All tests passed' : 'âŒ Tests failed'}\n\nFor details, check the [test run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
