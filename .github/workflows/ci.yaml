name: CI Tests for Pull Requests

on:
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: 🧪 Run Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    steps:
      - name: 🔒 Security Scan Dependencies
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip
          check-latest: true

      - name: 🔧 Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade poetry

      - name: 📚 Install Dependencies
        run: poetry install --with test

      - name: 🧪 Run Tests via Makefile
        run: make tests

      - name: 📝 Report Test Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = context.steps.tests.outcome === 'success';
            const message = `## 🧪 Test Results\n\n${success ? '✅ All tests passed' : '❌ Tests failed'}\n\nFor details, check the [test run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
